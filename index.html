<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula One History</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #FDFDFB; /* Slightly warmer off-white */
            color: #212529; /* Darker, more standard body text */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.6; /* Improved readability */
        }

        .container {
            width: 650px; /* Slightly wider for better spacing */
            max-width: 90%; /* Responsive margin on smaller screens */
            padding: 30px 20px; /* Increased padding */
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 3em; /* Larger for impact */
            color: #1C4E80;
            text-align: center;
            margin-bottom: 0.3em;
            letter-spacing: -0.5px; /* Subtle letter spacing */
        }

        .deck {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 1.15em;
            color: #495057; /* Softer, desaturated gray */
            text-align: center;
            margin-bottom: 3em;
        }

        h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: #1C4E80;
            margin-top: 0;
            margin-bottom: 0.75em; /* Spacing for step content */
        }

        .step {
            margin-bottom: 70vh; /* Fine-tuned scroll space */
            padding: 30px;
            border-radius: 10px;
            background-color: #FFFFFF;
            box-shadow: 0 5px 15px rgba(0,0,0,0.07);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
            border-left: 4px solid transparent; /* For active state */
        }

        .step.active {
            background-color: #FFFFFF;
            box-shadow: 0 8px 25px rgba(28, 78, 128, 0.15); /* Shadow using primary color tint */
            transform: translateY(-2px); /* Subtle lift */
            border-left: 4px solid #1C4E80; /* Accent for active step */
        }

        .chart-container {
            width: 100%;
            height: 420px; /* Slightly taller charts */
            margin-bottom: 2.5em;
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease-in-out; /* Slower fade for charts */
        }

        .chart-container.chart-active {
            display: block;
            opacity: 1;
        }

        svg {
            width: 100%;
            height: 100%;
            display: block;
            background-color: transparent; /* Let container handle bg or make it explicit if needed */
            overflow: visible; /* Important for elements like annotations that might go slightly out */
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #adb5bd; /* Lighter gray for axes */
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: 'Roboto', sans-serif;
            font-size: 0.78em;
            fill: #495057;
        }

        .grid line {
            stroke: #dee2e6; /* Very light grid lines */
            stroke-opacity: 0.6;
            shape-rendering: crispEdges;
        }

        .chart-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.05em;
            fill: #343a40; /* Darker title */
            text-anchor: middle;
        }

        /* Chart-specific styles */
        .line-champion-age {
            fill: none;
            stroke: #1C4E80;
            stroke-width: 2.5px; /* Slightly thicker line */
            transition: stroke-width 0.2s ease-in-out;
        }

        .regression-line {
            fill: none;
            stroke: #D55E00;
            stroke-width: 2px; /* Slightly thicker */
            stroke-dasharray: 5, 5; /* Adjusted dash */
        }

        .bar-constructor {
            stroke: none; /* Remove stroke for cleaner bars */
            transition: opacity 0.2s ease-in-out, filter 0.2s ease-in-out;
        }
        .bar-constructor:hover {
            filter: brightness(1.15); /* Brighter on hover */
        }


        .area-nationality {
            stroke-width: 0.5px;
            stroke: #fff; /* White stroke for separation */
            stroke-opacity: 0.5;
            transition: opacity 0.2s ease-in-out, filter 0.2s ease-in-out;
        }
         .area-nationality:hover {
            filter: brightness(1.1);
        }

        .hover-circle { /* For champion age chart */
             transition: r 0.2s ease-in-out, fill 0.2s ease-in-out;
        }


        .highlight {
            /* Define highlight style, e.g., increased stroke-width or opacity */
        }

        .tooltip {
            position: absolute;
            text-align: left; /* Better for multi-line tooltips */
            padding: 10px 15px; /* More padding */
            font-family: 'Roboto', sans-serif;
            font-size: 0.9em; /* Slightly larger tooltip text */
            background: rgba(30, 30, 30, 0.95); /* Dark, slightly transparent */
            color: #f8f9fa; /* Light text */
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.15s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
            max-width: 250px; /* Prevent overly wide tooltips */
        }
        .tooltip strong {
            color: #fff; /* Ensure strong tag is bright */
            font-weight: 700;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Formula One: A Visual History</h1>
            <p class="deck">Exploring decades of speed, strategy, and skill through data.</p>
        </header>

        <div id="scrolly">
            <div class="chart-container" id="chart-container-1">
                <svg id="chart1" role="img" aria-labelledby="chart1-title">
                    <title id="chart1-title">Average Age of Formula One Champions Over Time</title>
                </svg>
            </div>
            <div class="step" data-chart="1" data-step-id="championAgeIntro">
                <h2>The Evolving Champion</h2>
                <p>Formula One has seen champions of all ages. This chart tracks the average age of the World Champion each year, revealing trends in when drivers typically reach their peak.</p>
            </div>
            <div class="step" data-chart="1" data-step-id="championAgeRegression">
                <p>A regression line helps visualize the overall trend. Has the average age of champions been increasing, decreasing, or staying relatively stable over the decades?</p>
            </div>

            <div class="chart-container" id="chart-container-2">
                <svg id="chart2" role="img" aria-labelledby="chart2-title">
                    <title id="chart2-title">Constructor Title Streaks in Formula One</title>
                </svg>
            </div>
            <div class="step" data-chart="2" data-step-id="constructorStreaksIntro">
                <h2>Eras of Dominance</h2>
                <p>Certain constructors have defined eras in Formula One with extended periods of championship success. This timeline highlights the longest title streaks.</p>
            </div>
             <div class="step" data-chart="2" data-step-id="constructorHighlight">
                <p>Notice how some teams managed to maintain their competitive edge for multiple consecutive years, shaping the sport's history.</p>
            </div>

            <div class="chart-container" id="chart-container-3">
                <svg id="chart3" role="img" aria-labelledby="chart3-title">
                    <title id="chart3-title">Driver Nationality Wins Per Decade</title>
                </svg>
            </div>
            <div class="step" data-chart="3" data-step-id="nationalityWinsIntro">
                <h2>Global Talent Pool</h2>
                <p>Formula One attracts drivers from around the world. This chart explores the distribution of wins by driver nationality across different decades, showcasing which nations have historically produced the most successful drivers.</p>
            </div>
            <div class="step" data-chart="3" data-step-id="nationalityFocus">
                <p>Observe how the prominence of certain nationalities has shifted over time, reflecting the global growth and changing dynamics of the sport.</p>
            </div>
        </div>

        <footer>
            <p style="text-align:center; font-size:0.8em; color:#777;">Data sources: championAge.csv, constructorStreaks.csv, nationalityWins.csv (pre-filtered historical summaries). Visualisation by Jules.</p>
        </footer>
    </div>

    <script>
        const championAgeCsvData = \`year,avgChampionAge
1950,40
1951,40
1952,36
1953,36
1954,40
1955,38
1956,44
1957,46
1958,24
1959,33
1960,34
1961,29
1962,36
1963,27
1964,30
1965,29
1966,30
1967,32
1968,42
1969,30
1970,28
1971,32
1972,25
1973,34
1974,27
1975,28
1976,27
1977,28
1978,28
1979,29
1980,28
1981,29
1982,30
1983,31
1984,33
1985,30
1986,31
1987,30
1988,30
1989,34
1990,31
1991,31
1992,39
1993,38
1994,25
1995,26
1996,27
1997,28
1998,30
1999,31
2000,31
2001,32
2002,33
2003,34
2004,35
2005,24
2006,25
2007,27
2008,23
2009,29
2010,23
2011,24
2012,25
2013,26
2014,29
2015,30
2016,31
2017,32
2018,33
2019,34
2020,35
2021,24
2022,25
2023,26\`;

        const constructorStreaksCsvData = \`team,startYear,endYear,length
Ferrari,1952,1953,2
Mercedes,1954,1955,2
Cooper,1959,1960,2
Ferrari,1961,1961,1
BRM,1962,1962,1
Lotus,1963,1963,1
Ferrari,1964,1964,1
Lotus,1965,1965,1
Brabham,1966,1967,2
Lotus,1968,1968,1
Matra,1969,1969,1
Lotus,1970,1970,1
Tyrrell,1971,1971,1
Lotus,1972,1973,2
McLaren,1974,1974,1
Ferrari,1975,1977,3
Lotus,1978,1978,1
Ferrari,1979,1979,1
Williams,1980,1981,2
Ferrari,1982,1983,2
McLaren,1984,1985,2
Williams,1986,1987,2
McLaren,1988,1991,4
Williams,1992,1994,3
Benetton,1995,1995,1
Williams,1996,1997,2
McLaren,1998,1998,1
Ferrari,1999,2004,6
Renault,2005,2006,2
Ferrari,2007,2008,2
Brawn GP,2009,2009,1
Red Bull,2010,2013,4
Mercedes,2014,2021,8
Red Bull,2022,2023,2\`;

        const nationalityWinsCsvData = \`decade,nationality,wins
1950,Argentine,18
1950,Italian,14
1950,American,3
1950,British,1
1960,British,61
1960,American,10
1960,New Zealander,10
1960,Australian,9
1960,German,2
1970,British,42
1970,Brazilian,14
1970,Austrian,13
1970,Argentine,9
1970,Swedish,9
1980,Brazilian,35
1980,French,27
1980,Finnish,10
1980,Australian,7
1980,Austrian,7
1990,British,34
1990,German,29
1990,Brazilian,21
1990,French,10
1990,Canadian,1
2000,German,57
2000,Brazilian,20
2000,Finnish,19
2000,Spanish,16
2000,British,11
2010,German,66
2010,British,56
2010,Australian,11
2010,Finnish,10
2010,Spanish,8
2020,Dutch,49
2020,British,20
2020,Mexican,4
2020,French,3
2020,Finnish,2\`;

        function parseAndCleanData() {
            let championAgeData = d3.csvParse(championAgeCsvData, d => ({
                year: +d.year,
                avgChampionAge: +d.avgChampionAge
            }));
            championAgeData = removeOutliers(championAgeData, 'avgChampionAge');

            let constructorStreaksData = d3.csvParse(constructorStreaksCsvData, d => ({
                team: d.team,
                startYear: +d.startYear,
                endYear: +d.endYear,
                length: +d.length
            }));

            let nationalityWinsData = d3.csvParse(nationalityWinsCsvData, d => ({
                decade: +d.decade,
                nationality: d.nationality,
                wins: +d.wins
            }));
            nationalityWinsData = removeOutliers(nationalityWinsData, 'wins');

            const totalWinsByNationality = d3.rollup(nationalityWinsData, v => d3.sum(v, d => d.wins), d => d.nationality);
            const top5Nationalities = Array.from(totalWinsByNationality.entries())
                                          .sort((a, b) => b[1] - a[1])
                                          .slice(0, 5)
                                          .map(d => d[0]);

            const filteredNationalityWinsData = nationalityWinsData.filter(d => top5Nationalities.includes(d.nationality));

            return { championAgeData, constructorStreaksData, filteredNationalityWinsData, top5Nationalities };
        }

        function removeOutliers(data, columnName) {
            if (!data || data.length === 0) return [];
            const values = data.map(d => d[columnName]).sort(d3.ascending);
            const q1 = d3.quantile(values, 0.25);
            const q3 = d3.quantile(values, 0.75);
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            return data.filter(d => d[columnName] >= lowerBound && d[columnName] <= upperBound);
        }

        let processedData;

        document.addEventListener('DOMContentLoaded', () => {
            processedData = parseAndCleanData();
            console.log("Processed Data:", processedData);

            try {
                initChampionAgeChart();
            } catch (e) {
                console.error("Error initializing Champion Age Chart:", e);
            }
            try {
                initConstructorStreaksChart();
            } catch (e) {
                console.error("Error initializing Constructor Streaks Chart:", e);
            }
            try {
                initNationalityWinsChart();
            } catch (e) {
                console.error("Error initializing Nationality Wins Chart:", e);
            }

            try {
                initScrollytelling();
            } catch (e) {
                console.error("Error initializing Scrollytelling:", e);
            }

            console.log('Size KB:',(new Blob([document.documentElement.outerHTML]).size/1024).toFixed(1));
        });

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        function initChampionAgeChart() {
            const data = processedData.championAgeData;
            if (!data || data.length === 0) {
                console.warn("Champion age data is empty or undefined. Skipping chart rendering.");
                return;
            }

            const svg = d3.select("#chart1");
            const margin = {top: 40, right: 30, bottom: 50, left: 50};
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const chartG = svg.append("g")
                .attr("transform", \`translate(\${margin.left},\${margin.top})\`);

            svg.append("text")
                .attr("class", "chart-title")
                .attr("x", (width + margin.left + margin.right) / 2)
                .attr("y", margin.top / 2 + 5)
                .attr("text-anchor", "middle")
                .text("Average Age of F1 Champions (1950-2023)");

            const x = d3.scaleLinear().domain(d3.extent(data, d => d.year)).range([0, width]);
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.avgChampionAge) * 1.1]).range([height, 0]);

            const xAxis = d3.axisBottom(x).tickFormat(d3.format("d")).ticks(10);
            const yAxis = d3.axisLeft(y);

            chartG.append("g").attr("class", "axis x-axis").attr("transform", \`translate(0,\${height})\`).call(xAxis);
            chartG.append("g").attr("class", "axis y-axis").call(yAxis);

            chartG.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));

            const line = d3.line().x(d => x(d.year)).y(d => y(d.avgChampionAge));

            const mainLine = chartG.append("path") // Storing mainLine reference earlier
                .datum(data)
                .attr("class", "line-champion-age data-line")
                .attr("d", line)
                .attr("aria-label", "Line showing average champion age per year");

            chartG.selectAll(".hover-circle")
                .data(data)
                .enter().append("circle")
                .attr("class", "hover-circle")
                .attr("cx", d => x(d.year))
                .attr("cy", d => y(d.avgChampionAge))
                .attr("r", 5)
                .style("fill", "transparent")
                .style("pointer-events", "all")
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(\`<strong>Year:</strong> \${d.year}<br/><strong>Avg Age:</strong> \${d.avgChampionAge.toFixed(1)}\`)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    d3.select(this).attr("r", 7).style("fill", "#D55E00");
                    mainLine.style("stroke-width", "3px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                    d3.select(this).attr("r", 5).style("fill", "transparent");
                    mainLine.style("stroke-width", "2px");
                });

            const xMean = d3.mean(data, d => d.year);
            const yMean = d3.mean(data, d => d.avgChampionAge);
            const numerator = d3.sum(data, d => (d.year - xMean) * (d.avgChampionAge - yMean));
            const denominator = d3.sum(data, d => Math.pow(d.year - xMean, 2));
            const slope = numerator / denominator;
            const intercept = yMean - slope * xMean;
            const regressionPoints = data.map(d => ({ year: d.year, avgChampionAge: slope * d.year + intercept }));

            chartG.append("path").datum(regressionPoints).attr("class", "regression-line").attr("d", line)
                .attr("aria-label", "Regression line showing trend of average champion age");

            const youngest = data.reduce((min, p) => p.avgChampionAge < min.avgChampionAge ? p : min, data[0]);
            const oldest = data.reduce((max, p) => p.avgChampionAge > max.avgChampionAge ? p : max, data[0]);
            const annotationsData = [
                { year: youngest.year, age: youngest.avgChampionAge, label: \`Youngest Avg: \${youngest.avgChampionAge} (\${youngest.year})\` },
                { year: oldest.year, age: oldest.avgChampionAge, label: \`Oldest Avg: \${oldest.avgChampionAge} (\${oldest.year})\` }
            ];

            const annotationGroup = chartG.append("g").attr("class", "annotations");
            annotationsData.forEach(ann => {
                const annX = x(ann.year);
                const annY = y(ann.age);
                annotationGroup.append("circle").attr("cx", annX).attr("cy", annY).attr("r", 4).attr("fill", "#0072B2");
                annotationGroup.append("text").attr("x", annX + 5).attr("y", annY - 5).text(ann.label).attr("font-size", "0.7em").attr("fill", "#0072B2");
            });

            svg.node()._chartUpdate = (stepId) => {
                mainLine.classed("highlight", stepId === "championAgeIntro" || stepId === "championAgeRegression");
                chartG.selectAll(".regression-line").style("opacity", stepId === "championAgeRegression" ? 1 : 0.3);
                annotationGroup.style("opacity", (stepId === "championAgeIntro" || stepId === "championAgeRegression") ? 1 : 0.3);
            };
        }

        function initConstructorStreaksChart() {
            const data = processedData.constructorStreaksData;
            if (!data || data.length === 0) { return; }
            data.sort((a, b) => a.startYear - b.startYear || a.length - b.length);

            const svg = d3.select("#chart2");
            const margin = {top: 40, right: 30, bottom: 50, left: 100};
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            const chartG = svg.append("g").attr("transform", \`translate(\${margin.left},\${margin.top})\`);

            svg.append("text").attr("class", "chart-title").attr("x", (width + margin.left + margin.right) / 2).attr("y", margin.top / 2 + 5).attr("text-anchor", "middle").text("Constructor Championship Streaks (Min 1 Year)");

            const y = d3.scaleBand().domain(data.map(d => d.team + "_" + d.startYear)).range([0, height]).padding(0.2);
            const x = d3.scaleLinear().domain([d3.min(data, d => d.startYear) -1 , d3.max(data, d => d.endYear) + 1]).range([0, width]);

            const colorPalette = ["#1C4E80", "#D55E00", "#0072B2", "#E69F00", "#A0A0A0", "#505050"];
            const teamColors = {};
            let colorIndex = 0;
            data.forEach(d => {
                if (!teamColors[d.team]) { teamColors[d.team] = colorPalette[colorIndex++ % colorPalette.length]; }
            });

            const xAxis = d3.axisBottom(x).tickFormat(d3.format("d")).ticks(Math.min(10, (x.domain()[1]-x.domain()[0])));
            const yAxis = d3.axisLeft(y).tickFormat(val => val.split("_")[0]).tickSize(0).tickPadding(10);

            chartG.append("g").attr("class", "axis x-axis").attr("transform", \`translate(0,\${height})\`).call(xAxis);
            const yAxisGroup = chartG.append("g").attr("class", "axis y-axis").call(yAxis);
            yAxisGroup.select(".domain").remove();
            yAxisGroup.selectAll(".tick text").attr("fill", d => teamColors[d.split("_")[0]] || "#111");

            chartG.append("g").attr("class", "grid").attr("transform", \`translate(0,\${height})\`).call(d3.axisBottom(x).ticks(Math.min(10, (x.domain()[1]-x.domain()[0]))).tickSize(-height).tickFormat(""));

            const bars = chartG.selectAll(".bar-constructor").data(data).enter().append("rect")
                .attr("class", d => \`bar-constructor team-\${d.team.replace(/\s+/g, '-').toLowerCase()}\`)
                .attr("y", d => y(d.team + "_" + d.startYear)).attr("x", d => x(d.startYear))
                .attr("width", d => x(d.endYear + 1) - x(d.startYear)).attr("height", y.bandwidth())
                .attr("fill", d => teamColors[d.team] || "#777")
                .attr("aria-label", d => \`\${d.team} championship streak from \${d.startYear} to \${d.endYear}, \${d.length} years.\`)
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(\`<strong>Team:</strong> \${d.team}<br/><strong>Streak:</strong> \${d.startYear} - \${d.endYear}<br/><strong>Length:</strong> \${d.length} year(s)\`)
                        .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                    d3.select(this).style("opacity", 0.7);
                })
                .on("mouseout", function(d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                    d3.select(this).style("opacity", 1);
                });

            chartG.selectAll(".bar-label").data(data).enter().append("text").attr("class", "bar-label")
                .attr("x", d => x(d.startYear) + (x(d.endYear + 1) - x(d.startYear)) / 2)
                .attr("y", d => y(d.team + "_" + d.startYear) + y.bandwidth() / 2)
                .attr("dy", "0.35em").attr("text-anchor", "middle").text(d => d.length)
                .attr("fill", "#FFF").style("font-size", "0.7em").style("pointer-events", "none");

            svg.node()._chartUpdate = (stepId) => {
                const highlightTeam = stepId === "constructorHighlight" ? "Mercedes" : null;
                bars.transition().duration(300).attr("opacity", d => !highlightTeam || d.team === highlightTeam ? 1 : 0.3);
                yAxisGroup.selectAll(".tick text").transition().duration(300).attr("opacity", d => !highlightTeam || d.split("_")[0] === highlightTeam ? 1 : 0.3);
            };
        }

        function initNationalityWinsChart() {
            const rawData = processedData.filteredNationalityWinsData;
            const topNationalities = processedData.top5Nationalities;
            if (!rawData || rawData.length === 0 || !topNationalities || topNationalities.length === 0) { return; }

            const decades = Array.from(new Set(rawData.map(d => d.decade))).sort(d3.ascending);
            const dataForStacking = decades.map(decade => {
                const entry = { decade: decade };
                topNationalities.forEach(nat => {
                    const record = rawData.find(r => r.decade === decade && r.nationality === nat);
                    entry[nat] = record ? record.wins : 0;
                });
                return entry;
            });

            const stack = d3.stack().keys(topNationalities);
            const series = stack(dataForStacking);

            const svg = d3.select("#chart3");
            const margin = {top: 40, right: 30, bottom: 50, left: 50};
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;
            const chartG = svg.append("g").attr("transform", \`translate(\${margin.left},\${margin.top})\`);

            svg.append("text").attr("class", "chart-title").attr("x", (width + margin.left + margin.right) / 2).attr("y", margin.top / 2 + 5).attr("text-anchor", "middle").text("Wins by Top 5 Nationalities per Decade");

            const x = d3.scalePoint().domain(decades).range([0, width]).padding(0.5);
            const y = d3.scaleLinear().domain([0, d3.max(series, s => d3.max(s, d => d[1]))]).range([height, 0]);
            const colorPalette = ["#1C4E80", "#D55E00", "#0072B2", "#E69F00", "#785EF0"];
            const color = d3.scaleOrdinal().domain(topNationalities).range(colorPalette);

            const xAxis = d3.axisBottom(x).tickFormat(d => d + "s");
            const yAxis = d3.axisLeft(y);
            chartG.append("g").attr("class", "axis x-axis").attr("transform", \`translate(0,\${height})\`).call(xAxis);
            chartG.append("g").attr("class", "axis y-axis").call(yAxis);
            chartG.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));

            const area = d3.area().x(d => x(d.data.decade)).y0(d => y(d[0])).y1(d => y(d[1]));

            const areas = chartG.selectAll(".area-nationality").data(series).enter().append("path")
                .attr("class", d => \`area-nationality nationality-\${d.key.replace(/\s+/g, '-').toLowerCase()}\`)
                .attr("d", area).style("fill", d => color(d.key))
                .attr("aria-label", d => \`Area showing wins for \${d.key} drivers per decade.\`)
                .on("mouseover", function(event, d_series) {
                    const key = d_series.key;
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(\`<strong>Nationality:</strong> \${key}\`).style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                    areas.style("opacity", other_d => other_d.key === key ? 1 : 0.3);
                    legend.selectAll("g").style("opacity", leg_d => leg_d === key ? 1 : 0.5);
                })
                .on("mouseout", function(d) {
                    tooltip.transition().duration(500).style("opacity", 0);
                    areas.style("opacity", 1);
                    legend.selectAll("g").style("opacity", 1);
                });

            const legend = chartG.append("g").attr("class", "legend").attr("transform", \`translate(\${width - 100}, 0)\`);
            topNationalities.forEach((nationality, i) => {
                const legendRow = legend.append("g").datum(nationality).attr("transform", \`translate(0, \${i * 20})\`).style("cursor", "default")
                    .on("mouseover", function(event, d_nationality) {
                        tooltip.transition().duration(200).style("opacity", .9);
                        tooltip.html(\`<strong>Nationality:</strong> \${d_nationality}\`).style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
                        areas.style("opacity", area_d => area_d.key === d_nationality ? 1 : 0.3);
                        legend.selectAll("g").style("opacity", leg_d => leg_d === d_nationality ? 1 : 0.5);
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition().duration(500).style("opacity", 0);
                        areas.style("opacity", 1);
                        legend.selectAll("g").style("opacity", 1);
                    });
                legendRow.append("rect").attr("width", 10).attr("height", 10).attr("fill", color(nationality));
                legendRow.append("text").attr("x", 15).attr("y", 10).text(nationality).style("font-size", "0.7em").attr("alignment-baseline", "middle");
            });

            svg.node()._chartUpdate = (stepId) => {
                const highlightNationality = stepId === "nationalityFocus" ? topNationalities[0] : null;
                areas.transition().duration(300).style("opacity", d => !highlightNationality || d.key === highlightNationality ? 1 : 0.3);
                legend.selectAll("g").each(function(legendData, i) {
                    const nationality = topNationalities[i];
                    d3.select(this).transition().duration(300).style("opacity", () => !highlightNationality || nationality === highlightNationality ? 1 : 0.3);
                });
            };
        }

        function initScrollytelling() {
            const steps = d3.selectAll(".step");
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const stepElement = entry.target;
                    const stepId = stepElement.dataset.stepId;
                    const chartNumber = stepElement.dataset.chart;
                    const chartSvg = d3.select(\`#chart\${chartNumber}\`).node();

                    if (entry.isIntersecting) {
                        steps.classed("active", false);
                        d3.select(stepElement).classed("active", true);
                        if (chartSvg && typeof chartSvg._chartUpdate === 'function') {
                            chartSvg._chartUpdate(stepId);
                        }
                        d3.selectAll(".chart-container").classed("chart-active", false);
                        d3.select(\`#chart-container-\${chartNumber}\`).classed("chart-active", true);
                    }
                });
            }, { threshold: 0.5, rootMargin: "-10% 0px -50% 0px" });

            steps.each(function() { observer.observe(this); });

            const firstStep = d3.select(".step");
            if (!firstStep.empty()) {
                const firstChartNumber = firstStep.attr("data-chart");
                const firstStepId = firstStep.attr("data-step-id");
                d3.select(\`#chart-container-\${firstChartNumber}\`).classed("chart-active", true);
                firstStep.classed("active", true);
                const firstChartSvg = d3.select(\`#chart\${firstChartNumber}\`).node();
                if (firstChartSvg && typeof firstChartSvg._chartUpdate === 'function') {
                    firstChartSvg._chartUpdate(firstStepId);
                }
            }
        }
    </script>
</body>
</html>
